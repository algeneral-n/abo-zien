/**
 * RARE 4N - Council Agent
 * ???????? ???????????????????? - ???????? ???????? ???????????? ???????????????? (????????)
 * ??? ?????? ?????? Kernel ?? Cognitive Loop ??????
 */

import { BaseAgent } from './BaseAgent';
import { RAREKernel } from '../RAREKernel';

export interface CouncilMember {
  id: string;
  name: string;
  role: string;
  expertise: string[];
  perspective: string;
}

export interface CouncilDebate {
  id: string;
  topic: string;
  question: string;
  members: CouncilMember[];
  opinions: Array<{
    memberId: string;
    memberName: string;
    opinion: string;
    reasoning: string;
    confidence: number;
  }>;
  consensus: string | null;
  recommendation: string | null;
  timestamp: number;
}

export class CouncilAgent extends BaseAgent {
  private councilMembers: CouncilMember[] = [
    {
      id: 'strategic',
      name: '???????????????? ??????????????????????',
      role: 'Strategic Advisor',
      expertise: ['business', 'planning', 'growth'],
      perspective: '???????? ?????? ?????????????? ???????? ?????????? ?????????????? ??????????????????????',
    },
    {
      id: 'financial',
      name: '???????????????? ????????????',
      role: 'Financial Advisor',
      expertise: ['finance', 'investment', 'wealth'],
      perspective: '???????? ?????? ???????????? ???????????? ???????????????????? ???????????? ??????????????????',
    },
    {
      id: 'social',
      name: '???????????????? ??????????????????',
      role: 'Social Advisor',
      expertise: ['relationships', 'networking', 'community'],
      perspective: '???????? ?????? ???????????? ?????????????????? ?????????????????? ????????????????',
    },
    {
      id: 'health',
      name: '???????????????? ??????????',
      role: 'Health Advisor',
      expertise: ['health', 'wellness', 'fitness'],
      perspective: '???????? ?????? ?????????? ???????????????? ???????????????? ??????????????',
    },
    {
      id: 'life',
      name: '???????????????? ??????????????',
      role: 'Life Advisor',
      expertise: ['lifestyle', 'balance', 'happiness'],
      perspective: '???????? ?????? ?????????????? ?????????????? ???????????????? ??????????????????',
    },
  ];

  private debates: Map<string, CouncilDebate> = new Map();
  private ownerGoals: {
    financial: string[];
    social: string[];
    health: string[];
    life: string[];
  } = {
    financial: [],
    social: [],
    health: [],
    life: [],
  };

  constructor() {
    super({
      id: 'council',
      name: 'Council Agent',
      description: '???????? ???????????????????? - ???????? ???????? ???????????? ????????????????',
      capabilities: ['debate', 'recommendation', 'advice', 'consensus', 'client_greeting', 'client_action'],
    });
  }

  protected async onInit(): Promise<void> {
    // Load owner goals from memory
    await this.loadOwnerGoals();
    
    console.log('[CouncilAgent] Initialized ???');
  }


  /**
   * Load owner goals from Memory Engine
   */
  private async loadOwnerGoals(): Promise<void> {
    if (!this.kernel) return;
    
    // Access Memory Engine through Kernel
    const memoryEngine = this.kernel.getMemoryEngine();
    if (!memoryEngine) return;

    // Load goals from memory
    const financialGoals = await memoryEngine.query({
      tags: ['goal', 'financial', 'owner'],
      limit: 10,
    });
    const socialGoals = await memoryEngine.query({
      tags: ['goal', 'social', 'owner'],
      limit: 10,
    });
    const healthGoals = await memoryEngine.query({
      tags: ['goal', 'health', 'owner'],
      limit: 10,
    });
    const lifeGoals = await memoryEngine.query({
      tags: ['goal', 'life', 'owner'],
      limit: 10,
    });

    this.ownerGoals.financial = financialGoals.map(m => m.content?.goal || '');
    this.ownerGoals.social = socialGoals.map(m => m.content?.goal || '');
    this.ownerGoals.health = healthGoals.map(m => m.content?.goal || '');
    this.ownerGoals.life = lifeGoals.map(m => m.content?.goal || '');
  }

  /**
   * Execute action (required by BaseAgent)
   */
  protected async onExecuteAction(action: string, parameters: any): Promise<any> {
    switch (action) {
      case 'start_debate':
        return await this.startDebate(parameters.topic, parameters.question);
      
      case 'get_recommendation':
        return await this.getRecommendation(parameters.question, parameters.context);
      
      case 'update_goals':
        return await this.updateGoals(parameters.goals);
      
      case 'get_goals':
        return await this.getGoals();
      
      case 'client_greeting':
        return await this.getClientGreeting(parameters.clientInfo);
      
      case 'client_action':
        return await this.getClientAction(parameters.clientRequest, parameters.context);
      
      default:
        throw new Error(`Unknown action: ${action}`);
    }
  }

  /**
   * Start a council debate on a topic
   */
  private async startDebate(topic: string, question: string): Promise<CouncilDebate> {
    const debateId = `debate_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // Get opinions from each council member
    const opinions = await Promise.all(
      this.councilMembers.map(async (member) => {
        const opinion = await this.getMemberOpinion(member, question, topic);
        return {
          memberId: member.id,
          memberName: member.name,
          opinion: opinion.opinion,
          reasoning: opinion.reasoning,
          confidence: opinion.confidence,
        };
      })
    );

    // Generate consensus and recommendation
    const consensus = this.generateConsensus(opinions);
    const recommendation = this.generateRecommendation(opinions, consensus, topic);

    const debate: CouncilDebate = {
      id: debateId,
      topic,
      question,
      members: this.councilMembers,
      opinions,
      consensus,
      recommendation,
      timestamp: Date.now(),
    };

    this.debates.set(debateId, debate);

    // Emit result via Kernel
    this.kernel?.emit({
      type: 'agent:council:response',
      data: {
        debate,
        discussions: Array.from(this.debates.values()),
      },
      timestamp: Date.now(),
      source: 'council',
    });

    return debate;
  }

  /**
   * Get opinion from a council member
   */
  private async getMemberOpinion(
    member: CouncilMember,
    question: string,
    topic: string
  ): Promise<{ opinion: string; reasoning: string; confidence: number }> {
    // Use AI Engine to generate opinion based on member's perspective
    if (!this.kernel) {
      // Fallback
      return {
        opinion: `???? ???????? ?????? ${member.name}: ?????? ?????????????? ?????? ${member.perspective}`,
        reasoning: member.perspective,
        confidence: 0.7,
      };
    }
    
    const aiEngine = this.kernel.getEngine('ai');
    if (!aiEngine) {
      // Fallback
      return {
        opinion: `???? ???????? ?????? ${member.name}: ?????? ?????????????? ?????? ${member.perspective}`,
        reasoning: member.perspective,
        confidence: 0.7,
      };
    }

    const prompt = `?????? ${member.name} (${member.role})?? ?????????? ???? ${member.expertise.join(' ?? ')}.
    
???????? ????????: ${member.perspective}

??????????: ???????????? ?????????????? ?????????????? ???????????? ???????????????????? ???????????????? ???????????? ?????????? (????????????????).

????????????: ${question}
??????????????: ${topic}

?????? ???????? ???????????? ???? ?????????????? ??????:
1. ?????? ?????????? ?????? ???????? ???? ??????????????
2. ???? ???? ?????????????? ??????????????/????????????????????/????????????????/??????????????
3. ???? ???? ???????????????? ????????????????

????????????: ?????? ???????? ???????? ?????????? ?????????? ???????????? ???? ????????????.`;

    try {
      const response = await aiEngine.executeAction('ai_chat', {
        message: prompt,
        context: {
          member: member.name,
          role: member.role,
          perspective: member.perspective,
        },
      });

      return {
        opinion: response.response || response.text || `?????? ${member.name}`,
        reasoning: `?????????? ?????? ???????? ${member.name} ???? ${member.expertise.join(' ?? ')}`,
        confidence: 0.85,
      };
    } catch (error) {
      console.error(`[CouncilAgent] Error getting opinion from ${member.name}:`, error);
      return {
        opinion: `???? ???????? ?????? ${member.name}: ?????? ?????????????? ?????? ${member.perspective}`,
        reasoning: member.perspective,
        confidence: 0.7,
      };
    }
  }

  /**
   * Generate consensus from opinions
   */
  private generateConsensus(opinions: any[]): string {
    // Analyze common themes
    const themes: Map<string, number> = new Map();
    
    opinions.forEach(opinion => {
      const words = opinion.opinion.toLowerCase().split(/\s+/);
      words.forEach(word => {
        if (word.length > 4) {
          themes.set(word, (themes.get(word) || 0) + 1);
        }
      });
    });

    const topThemes = Array.from(themes.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([word]) => word);

    return `?????????????? ??????????: ?????????????? ?????? ${topThemes.join(' ?? ')} ???????????? ???????????? ?????????????? ??????????.`;
  }

  /**
   * Generate final recommendation
   */
  private generateRecommendation(opinions: any[], consensus: string, topic: string): string {
    const topOpinions = opinions
      .sort((a, b) => b.confidence - a.confidence)
      .slice(0, 3);

    return `?????????????? ???????????????? ???? ????????????:

${consensus}

???????????? ????????????????:
${topOpinions.map((o, i) => `${i + 1}. ${o.memberName}: ${o.opinion.substring(0, 100)}...`).join('\n')}

??????????: ???????????? ?????????????? ?????????????? ???????????? ???????????????????? ???????????????? ???????????? ??????????.

?????????????? ??????????????: ?????????? ?????? ???????????? ???????? ?????? ???????? ???????????? ???? ?????????????? ?????? ?????????? ?????????? ????????.`;
  }

  /**
   * Get recommendation for a specific question
   */
  private async getRecommendation(question: string, context?: any): Promise<string> {
    const debate = await this.startDebate('general', question);
    return debate.recommendation || debate.consensus || '???? ???????? ?????????? ?????????? ????????????';
  }

  /**
   * Update owner goals
   */
  private async updateGoals(goals: {
    financial?: string[];
    social?: string[];
    health?: string[];
    life?: string[];
  }): Promise<void> {
    if (goals.financial) this.ownerGoals.financial = goals.financial;
    if (goals.social) this.ownerGoals.social = goals.social;
    if (goals.health) this.ownerGoals.health = goals.health;
    if (goals.life) this.ownerGoals.life = goals.life;

    // Store in Memory Engine
    if (!this.kernel) return;
    
    const memoryEngine = this.kernel.getMemoryEngine();
    if (memoryEngine) {
      if (goals.financial) {
        goals.financial.forEach(goal => {
          memoryEngine.storeLearning({
            id: `goal_financial_${Date.now()}`,
            type: 'goal',
            category: 'financial',
            content: { goal, owner: 'nader' },
            importance: 0.9,
            tags: ['goal', 'financial', 'owner'],
          });
        });
      }
      // Similar for other goals...
    }
  }

  /**
   * Get current goals
   */
  private getGoals(): typeof this.ownerGoals {
    return { ...this.ownerGoals };
  }

  /**
   * Get client greeting recommendation
   */
  private async getClientGreeting(clientInfo: any): Promise<string> {
    const question = `?????? ???????? ?????????? ???????? ???????? ${clientInfo.name || '????????????'}??`;
    const recommendation = await this.getRecommendation(question, {
      clientInfo,
      type: 'greeting',
    });

    return recommendation || `???????????? ${clientInfo.name || '?????????? ????????????'}! ?????????? ???? ???? RARE 4N. ?????? ???????????? ?????????????? ????????????`;
  }

  /**
   * Get action recommendation for client request
   */
  private async getClientAction(clientRequest: string, context?: any): Promise<string> {
    const question = `???????? ?????? ???? ???????? ?????????? ???????? ????????????: "${clientRequest}"??`;
    const recommendation = await this.getRecommendation(question, {
      clientRequest,
      context,
      type: 'client_action',
    });

    return recommendation || `?????? ???????????? ?????? ???????????? ?????????? ???????????? ???? ???????????? ?????? ????????.`;
  }
}


